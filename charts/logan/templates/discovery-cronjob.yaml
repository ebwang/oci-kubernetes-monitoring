# Copyright (c) 2023, Oracle and/or its affiliates.
# Licensed under the Universal Permissive License v1.0 as shown at https://oss.oracle.com/licenses/upl.
---
{{- $authtype := .Values.authtype | lower }}
{{- $resourceNamePrefix := .Values.global.resourceNamePrefix }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ .Values.global.resourceNamePrefix }}-discovery
  namespace: {{ include "logan.namespace" . }}
spec:
  schedule: {{ .Values.objectDiscovery.cronSchedule | quote }}
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          serviceAccountName: {{ include "logan.serviceAccount" . }}
          containers:
          - name: k8-discovery-job
            image: {{ .Values.objectDiscovery.image.url }}
            env:
            - name: K8_CLUSTER_NAME
              valueFrom:
                configMapKeyRef:
                  name: {{ include "logan.resourceNamePrefix" . }}-discovery
                  key: k8_cluster_name
            - name: K8_CLUSTER_ENTITY_ID
              valueFrom:
                configMapKeyRef:
                  name: {{ include "logan.resourceNamePrefix" . }}-discovery
                  key: k8_cluster_entity_id
            - name: OCI_LA_NAMESPACE
              valueFrom:
                configMapKeyRef:
                  name: {{ include "logan.resourceNamePrefix" . }}-discovery
                  key: oci_la_namespace
            - name: OCI_LA_LOG_GROUP_ID
              valueFrom:
                configMapKeyRef:
                  name: {{ include "logan.resourceNamePrefix" . }}-discovery
                  key: oci_la_log_group_id
            {{- if eq $authtype "config" }}
            volumeMounts:
            - name: ociconfigdir
              mountPath: /var/opt/.oci
              readOnly: true
            {{- end }}
            command:
                - oci-logan-oke-resources-discovery
                - --kubernetes_cluster_name
                - $(K8_CLUSTER_NAME)
                {{- if ne .Values.objectDiscovery.kubernetesClusterEntityID "" }}
                - --kubernetes_cluster_entity_id
                - $(K8_CLUSTER_ENTITY_ID)
                {{- end }}
                - --oci_la_namespace
                - $(OCI_LA_NAMESPACE)
                - --oci_la_log_group_id
                - $(OCI_LA_LOG_GROUP_ID)
                {{- if eq $authtype "config" }}
                - --config_file_location
                - {{ .Values.oci.path }}/{{ .Values.oci.file }}
                {{- end }}
                {{- if ne .Values.objectDiscovery.api_endpoint "" }}
                - --endpoint
                - {{ .Values.objectDiscovery.api_endpoint }}
                {{- end }}
          {{- if eq $authtype "config" }}
          volumes:
          - name: ociconfigdir
            projected:
              sources:
              - secret:
                  name: {{ $resourceNamePrefix }}-oci-config
          {{- end }}